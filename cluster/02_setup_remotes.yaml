- hosts: remote_workers
  become: yes
  tasks:
#    - name: Copy over additional netplan (e.g. external IP) configuration
#      copy:
#        src: config/netplan/51-network.yaml.{{ inventory_hostname }}
#        dest: /etc/netplan/51-network.yaml
#        mode: u=rwx,g=r,o=r
#      register: netplan_config

#    - name: Applying netplan...
#      shell: netplan try && netplan apply

    - name: Check if we've already configured iptables
      stat:
        path: /etc/iptables/rules.v4
      register: iptables
    
    - name: Make sure the iptables directory exists
      file:
        path: /etc/iptables
        state: directory

    - name: Allow traffic from this endpoint
      iptables:
        action: append
        chain: INPUT
        source: "{{ lookup('file', '../secrets/remotes/wgsdn') }}"
        jump: ACCEPT
      when: not iptables.stat.exists

    - name: Allow wireguard traffic
      iptables:
        action: append
        chain: INPUT
        protocol: udp
        destination_port: "51820"
        jump: ACCEPT
      when: not iptables.stat.exists

    - name: Wireguard SDN is secure, so we'll allow it all
      iptables:
        action: append
        chain: INPUT
        in_interface: wgsdn
        jump: ACCEPT
      when: not iptables.stat.exists

    - name: Allow established connections
      iptables:
        chain: INPUT
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT
      when: not iptables.stat.exists

    - name: Drop all incoming connections
      iptables:
        chain: INPUT
        policy: DROP
      when: not iptables.stat.exists

    - name: Save the rules.
      shell: iptables-save > /etc/iptables/rules.v4
      when: not iptables.stat.exists

    - name: Enable wireguard
      service:
        name: wg-quick@wgsdn
        state: started
        enabled: yes