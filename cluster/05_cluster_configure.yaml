- hosts: k8s-n1
  become: yes
  tasks:
    - name: Create temporary work directory.
      file:
        path: /tmp/k8s-network
        state: directory
  
    - name: Apply OVS-CNI DaemonSet
      shell: | 
        kubectl apply -f https://raw.githubusercontent.com/kubevirt/cluster-network-addons-operator/master/manifests/cluster-network-addons/0.40.1/namespace.yaml
        kubectl apply -f https://raw.githubusercontent.com/kubevirt/cluster-network-addons-operator/master/manifests/cluster-network-addons/0.40.1/network-addons-config.crd.yaml
        kubectl apply -f https://raw.githubusercontent.com/kubevirt/cluster-network-addons-operator/master/manifests/cluster-network-addons/0.40.1/operator.yaml

    - name: Creating MetalLB namespace.
      command:
        cmd: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.3/manifests/namespace.yaml

    - name: Installing MetalLB.
      command:
        cmd: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.3/manifests/metallb.yaml

    - name: Check if MetalLB secret has been generated
      stat:
        path: ~/.kube/metallb-secret.txt
      register: metallb_installed

    - name: One-time MetalLB secret generation
      shell: kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)" >> ~/.kube/metallb-secret.txt
      args:
        chdir: $HOME
        creates: ~/.kube/metallb-secret.txt
      when: not metallb_installed.stat.exists

    - name: Cleaning up remaining config.
      file:
        name: /tmp/k8s-network
        state: absent

    - name: Set kube-router gobgp listen address for remote hosts
      shell: kubectl annotate --overwrite node {{ hostvars[item].inventory_hostname + '.fnptr.net' }} "kube-router.io/bgp-local-addresses={{ hostvars[item].wgsdn_host }}"
      with_items: "{{ groups['remote_workers'] }}"

    - name: Set kube-router config for local masters
      shell: kubectl annotate node --overwrite {{ hostvars[item].inventory_hostname + '.fnptr.net' }} kube-router.io/node.asn=64512 kube-router.io/peer.ips=10.2.0.64 kube-router.io/peer.asns=65000
      with_items: "{{ groups['masters'] }}"

    - name: Set kube-router config for local hosts
      shell: kubectl annotate node --overwrite {{ hostvars[item].inventory_hostname + '.fnptr.net' }} kube-router.io/node.asn=64512 kube-router.io/peer.ips=10.2.0.64 kube-router.io/peer.asns=65000
      with_items: "{{ groups['local_workers'] }}"

    - name: Set kube-router config for remote hosts
      shell: kubectl annotate node --overwrite {{ hostvars[item].inventory_hostname + '.fnptr.net' }} kube-router.io/node.asn=65064 kube-router.io/peer.ips=100.64.255.254 kube-router.io/peer.asns=65000
      with_items: "{{ groups['remote_workers'] }}"

    - name: Restart kube-router
      shell: kubectl -n kube-system rollout restart daemonset kube-router